# Polymarket GitHub 项目整理

## 完整系统架构图

```
╔══════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                           用户入口层                                                 ║
╠══════════════════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                                      ║
║   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐              ║
║   │   Web App       │   │   Mobile App    │   │   Third Party   │   │   AI Agents     │              ║
║   │   (官方前端)    │   │   (官方移动端)  │   │   (第三方集成)  │   │   (自动交易)    │              ║
║   └────────┬────────┘   └────────┬────────┘   └────────┬────────┘   └────────┬────────┘              ║
║            │                     │                     │                     │                       ║
║            │    ┌────────────────┴─────────────────────┴─────────────────────┘                       ║
║            │    │                                                                                    ║
║            ▼    ▼                                                                                    ║
║   ┌──────────────────────────────────────────────────────────────────────────────────────────┐       ║
║   │                              SDK / Client Library                                        │       ║
║   │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │       ║
║   │  │ py-clob-client   │  │ clob-client (TS) │  │ rs-clob-client   │  │ polymarket-sdk   │  │       ║
║   │  │ Python客户端     │  │ TypeScript客户端 │  │ Rust客户端       │  │ 钱包交互SDK      │  │       ║
║   │  └──────────────────┘  └──────────────────┘  └──────────────────┘  └──────────────────┘  │       ║
║   │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐                        │       ║
║   │  │ python-order-    │  │ clob-order-utils │  │ go-order-utils   │   订单签名工具         │       ║
║   │  │ utils            │  │ (TS)             │  │ (Go)             │                        │       ║
║   │  └──────────────────┘  └──────────────────┘  └──────────────────┘                        │       ║
║   └──────────────────────────────────────────────────────────────────────────────────────────┘       ║
║                                              │                                                       ║
╚══════════════════════════════════════════════╪═══════════════════════════════════════════════════════╝
                                               │
                                               ▼
╔══════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                       认证与钱包层                                                   ║
╠══════════════════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                                      ║
║   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    ║
║   │                                   登录方式                                                  │    ║
║   │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐              │    ║
║   │   │  Email  │  │ Google  │  │  Apple  │  │ Discord │  │ Twitter │  │ Wallet  │              │    ║
║   │   │  邮箱   │  │  谷歌   │  │  苹果   │  │         │  │         │  │ Connect │              │    ║
║   │   └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘              │    ║
║   │        └────────────┴────────────┴────────────┴────────────┴────────────┘                   │    ║
║   └─────────────────────────────────────────────┬───────────────────────────────────────────────┘    ║
║                                                 │                                                    ║
║                                                 ▼                                                    ║
║   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    ║
║   │                              Privy (嵌入式钱包服务)                                         │    ║
║   │   ┌───────────────────────────────────────────────────────────────────────────────────┐     │    ║
║   │   │  MPC密钥管理                                                                      │     │    ║
║   │   │  ├── 用户设备持有密钥分片A                                                        │     │    ║
║   │   │  ├── Privy服务器持有密钥分片B                                                     │     │    ║
║   │   │  └── 需要两个分片才能签名 (阈值签名)                                              │     │    ║
║   │   └───────────────────────────────────────────────────────────────────────────────────┘     │    ║
║   │                                              │                                              │    ║
║   │                                              ▼ 创建/控制                                    │    ║
║   │   ┌───────────────────────────────────────────────────────────────────────────────────┐     │    ║
║   │   │  EOA (Externally Owned Account)                                                   │     │    ║
║   │   │  └── 用户不直接持有私钥，由Privy MPC系统管理                                      │     │    ║
║   │   └───────────────────────────────────────────────────────────────────────────────────┘     │    ║
║   └─────────────────────────────────────────────┬───────────────────────────────────────────────┘    ║
║                                                 │                                                    ║
║                                                 ▼ 作为Owner控制                                      ║
║   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    ║
║   │                            Safe智能合约钱包 (Polygon)                                       │    ║
║   │   ┌───────────────────────────────────────────────────────────────────────────────────┐     │    ║
║   │   │  地址: 0x用户Safe地址 (这是用户看到的"钱包地址")                                  │     │    ║
║   │   │  ├── Owner: Privy EOA                                                             │     │    ║
║   │   │  ├── 持有: USDC (抵押品)                                                          │     │    ║
║   │   │  ├── 持有: CTF条件代币 (各种市场头寸)                                             │     │    ║
║   │   │  └── 授权: CTF Exchange合约可以操作资产                                           │     │    ║
║   │   └───────────────────────────────────────────────────────────────────────────────────┘     │    ║
║   └─────────────────────────────────────────────────────────────────────────────────────────────┘    ║
║                                                                                                      ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════╝
                                               │
                     ┌─────────────────────────┴─────────────────────────┐
                     │                                                   │
                     ▼ 1. 用户签名订单 (EIP-712)                         │
                                                                         │
╔══════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                    链下系统 (Polymarket服务器)                                       ║
╠══════════════════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                                      ║
║   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    ║
║   │                                     API Gateway                                             │    ║
║   │   ├── REST API: 订单提交、查询、取消                                                        │    ║
║   │   ├── WebSocket: 实时行情推送、订单状态更新                                                 │    ║
║   │   └── 认证: Builder签名验证                                                                 │    ║
║   └─────────────────────────────────────────────┬───────────────────────────────────────────────┘    ║
║                                                 │                                                    ║
║                     ┌───────────────────────────┼───────────────────────────┐                        ║
║                     │                           │                           │                        ║
║                     ▼                           ▼                           ▼                        ║
║   ┌─────────────────────────┐   ┌─────────────────────────┐   ┌─────────────────────────┐            ║
║   │      Order Service      │   │    Matching Engine      │   │    Market Data Service  │            ║
║   │      订单服务           │   │    撮合引擎             │   │    行情服务             │            ║
║   │  ┌───────────────────┐  │   │  ┌───────────────────┐  │   │  ┌───────────────────┐  │            ║
║   │  │ 订单验证          │  │   │  │ 价格优先匹配      │  │   │  │ 实时价格计算      │  │            ║
║   │  │ ├─ 签名验证       │  │   │  │ 时间优先排序      │  │   │  │ 深度聚合          │  │            ║
║   │  │ ├─ 余额检查       │  │   │  │ 部分成交处理      │  │   │  │ K线生成           │  │            ║
║   │  │ ├─ 价格范围检查   │  │   │  │ 批量撮合优化      │  │   │  │ 成交量统计        │  │            ║
║   │  │ └─ 风控检查       │  │   │  └───────────────────┘  │   │  └───────────────────┘  │            ║
║   │  └───────────────────┘  │   │            │            │   │            │            │            ║
║   │           │             │   │            │            │   │            │            │            ║
║   └───────────┼─────────────┘   └────────────┼────────────┘   └────────────┼────────────┘            ║
║               │                              │                             │                         ║
║               ▼                              ▼                             ▼                         ║
║   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    ║
║   │                                    Order Book (内存)                                        │    ║
║   │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │    ║
║   │   │  Market: "Trump wins 2024"                                                          │   │    ║
║   │   │  ┌─────────────────────────────┐    ┌─────────────────────────────┐                 │   │    ║
║   │   │  │  Buy Orders (Bids)          │    │  Sell Orders (Asks)         │                 │   │    ║
║   │   │  │  ├─ 0.55 @ $50,000          │    │  ├─ 0.56 @ $30,000          │                 │   │    ║
║   │   │  │  ├─ 0.54 @ $120,000         │    │  ├─ 0.57 @ $80,000          │                 │   │    ║
║   │   │  │  ├─ 0.53 @ $200,000         │    │  ├─ 0.58 @ $150,000         │                 │   │    ║
║   │   │  │  └─ ...                     │    │  └─ ...                     │                 │   │    ║
║   │   │  └─────────────────────────────┘    └─────────────────────────────┘                 │   │    ║
║   │   └─────────────────────────────────────────────────────────────────────────────────────┘   │    ║
║   │   # 订单簿数据仅存在于此处，不上链，无法从区块链恢复                                        │    ║
║   └─────────────────────────────────────────────────────────────────────────────────────────────┘    ║
║                                                 │                                                    ║
║                                                 │ 撮合成功的订单                                     ║
║                                                 ▼                                                    ║
║   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    ║
║   │                              Builder / Relayer Service                                      │    ║
║   │   ┌───────────────────────────────────────────────────────────────────────────────────┐     │    ║
║   │   │  交易构建流程:                                                                    │     │    ║
║   │   │  1. 收集已撮合订单对 (maker order + taker order)                                  │     │    ║
║   │   │  2. 批量打包 (多个成交合并为一个交易，节省gas)                                    │     │    ║
║   │   │  3. 构建calldata: CTFExchange.matchOrders(makerOrders, takerOrders, ...)          │     │    ║
║   │   │  4. 估算gas，设置gasPrice                                                         │     │    ║
║   │   │  5. 用Relayer私钥签名交易                                                         │     │    ║
║   │   │  6. 提交到Polygon网络                                                             │     │    ║
║   │   │  7. 监控交易状态，失败重试                                                        │     │    ║
║   │   └───────────────────────────────────────────────────────────────────────────────────┘     │    ║
║   │   ┌───────────────────────────────────────────────────────────────────────────────────┐     │    ║
║   │   │  Gas代付机制:                                                                     │     │    ║
║   │   │  ├── 用户不需要持有MATIC                                                          │     │    ║
║   │   │  ├── Polymarket Relayer代付gas                                                    │     │    ║
║   │   │  └── 成本通过交易费用覆盖                                                         │     │    ║
║   │   └───────────────────────────────────────────────────────────────────────────────────┘     │    ║
║   └─────────────────────────────────────────────┬───────────────────────────────────────────────┘    ║
║                                                 │                                                    ║
║   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    ║
║   │                              real-time-data-client (官方实时数据)                           │    ║
║   │   ├── WebSocket订阅: 价格更新、成交推送、订单簿变化                                         │    ║
║   │   ├── 数据来源: 链下系统处理后推送 (不是直接从链上)                                         │    ║
║   │   └── 延迟: 毫秒级                                                                          │    ║
║   └─────────────────────────────────────────────────────────────────────────────────────────────┘    ║
║                                                                                                      ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════╝
                                               │
                                               │ 2. 链上交易提交
                                               ▼
╔══════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                      Polygon PoS (链上)                                              ║
╠══════════════════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                                      ║
║   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    ║
║   │                        CTF Exchange (核心交易合约)                                          │    ║
║   │   地址: 0x4bFb41d5B3570DeFd03C39a9A4D8dE6Bd8B8982E                                          │    ║
║   │   ┌───────────────────────────────────────────────────────────────────────────────────┐     │    ║
║   │   │  核心函数:                                                                        │     │    ║
║   │   │  ├── fillOrder(Order order, Signature sig)                                        │     │    ║
║   │   │  │   └── 执行单个订单                                                             │     │    ║
║   │   │  ├── fillOrders(Order[] orders, Signature[] sigs)                                 │     │    ║
║   │   │  │   └── 批量执行订单                                                             │     │    ║
║   │   │  ├── matchOrders(Order makerOrder, Order takerOrder, ...)                         │     │    ║
║   │   │  │   └── 撮合买卖订单                                                             │     │    ║
║   │   │  └── cancelOrder(Order order) / cancelOrders(Order[] orders)                      │     │    ║
║   │   │      └── 取消订单 (链上取消，防止被执行)                                          │     │    ║
║   │   └───────────────────────────────────────────────────────────────────────────────────┘     │    ║
║   │   ┌───────────────────────────────────────────────────────────────────────────────────┐     │    ║
║   │   │  验证流程:                                                                        │     │    ║
║   │   │  1. 验证EIP-712签名 → 确认是用户本人签署                                          │     │    ║
║   │   │  2. 验证订单未过期 → block.timestamp < order.expiration                           │     │    ║
║   │   │  3. 验证订单未取消 → 检查cancelled mapping                                        │     │    ║
║   │   │  4. 验证余额充足 → maker有足够的tokenA, taker有足够的tokenB                       │     │    ║
║   │   │  5. 验证授权充足 → 用户已approve Exchange操作其资产                               │     │    ║
║   │   │  6. 执行原子交换 → 同时转移双方资产                                               │     │    ║
║   │   └───────────────────────────────────────────────────────────────────────────────────┘     │    ║
║   │   ┌───────────────────────────────────────────────────────────────────────────────────┐     │    ║
║   │   │  Order结构 (EIP-712):                                                             │     │    ║
║   │   │  struct Order {                                                                   │     │    ║
║   │   │      uint256 salt;           // 随机数，确保唯一性                                │     │    ║
║   │   │      address maker;          // 挂单方地址                                        │     │    ║
║   │   │      address signer;         // 签名者 (可以是maker或授权的signer)                │     │    ║
║   │   │      address taker;          // 吃单方 (0x0表示任何人)                            │     │    ║
║   │   │      uint256 tokenId;        // CTF代币ID                                         │     │    ║
║   │   │      uint256 makerAmount;    // maker提供的数量                                   │     │    ║
║   │   │      uint256 takerAmount;    // taker提供的数量                                   │     │    ║
║   │   │      uint256 expiration;     // 过期时间戳                                        │     │    ║
║   │   │      uint256 nonce;          // 用于批量取消                                      │     │    ║
║   │   │      uint256 feeRateBps;     // 手续费率 (basis points)                           │     │    ║
║   │   │      uint8 side;             // 0=BUY, 1=SELL                                     │     │    ║
║   │   │      uint8 signatureType;    // 签名类型                                          │     │    ║
║   │   │  }                                                                                │     │    ║
║   │   └───────────────────────────────────────────────────────────────────────────────────┘     │    ║
║   │   ┌───────────────────────────────────────────────────────────────────────────────────┐     │    ║
║   │   │  Events (链上事件，可被索引):                                                     │     │    ║
║   │   │  ├── OrderFilled(orderHash, maker, taker, makerAssetId, takerAssetId, ...)        │     │    ║
║   │   │  ├── OrdersMatched(makerOrderHash, takerOrderHash, ...)                           │     │    ║
║   │   │  └── OrderCancelled(orderHash)                                                    │     │    ║
║   │   └───────────────────────────────────────────────────────────────────────────────────┘     │    ║
║   └─────────────────────────────────────────────┬───────────────────────────────────────────────┘    ║
║                                                 │                                                    ║
║                                                 │ 调用                                               ║
║                                                 ▼                                                    ║
║   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    ║
║   │                    Conditional Tokens (Gnosis CTF核心合约)                                  │    ║
║   │   地址: 0x4D97DCd97eC945f40cF65F87097ACe5EA0476045                                          │    ║
║   │   ┌───────────────────────────────────────────────────────────────────────────────────┐     │    ║
║   │   │  核心概念:                                                                        │     │    ║
║   │   │  ├── Condition: 一个问题/事件 (如"Trump是否赢得2024大选")                         │     │    ║
║   │   │  │   └── conditionId = keccak256(oracle, questionId, outcomeSlotCount)            │     │    ║
║   │   │  ├── Outcome Slot: 可能的结果 (如 Yes/No, 或 A/B/C/D)                             │     │    ║
║   │   │  ├── Position: 用户持有的条件代币                                                 │     │    ║
║   │   │  │   └── positionId = keccak256(collateralToken, collectionId)                    │     │    ║
║   │   │  └── CollectionId: 某个outcome组合的ID                                            │     │    ║
║   │   └───────────────────────────────────────────────────────────────────────────────────┘     │    ║
║   │   ┌───────────────────────────────────────────────────────────────────────────────────┐     │    ║
║   │   │  核心函数:                                                                        │     │    ║
║   │   │  ├── prepareCondition(oracle, questionId, outcomeSlotCount)                       │     │    ║
║   │   │  │   └── 创建新的条件/市场                                                        │     │    ║
║   │   │  ├── splitPosition(collateral, parentCollectionId, conditionId, partition, amt)   │     │    ║
║   │   │  │   └── 拆分: 100 USDC → 100 Yes + 100 No                                        │     │    ║
║   │   │  ├── mergePositions(collateral, parentCollectionId, conditionId, partition, amt)  │     │    ║
║   │   │  │   └── 合并: 100 Yes + 100 No → 100 USDC                                        │     │    ║
║   │   │  ├── redeemPositions(collateral, parentCollectionId, conditionId, indexSets)      │     │    ║
║   │   │  │   └── 赎回: 市场结算后，赢的一方兑换USDC                                       │     │    ║
║   │   │  └── reportPayouts(questionId, payouts)                                           │     │    ║
║   │   │      └── 只有指定的oracle可以调用，报告结果                                       │     │    ║
║   │   └───────────────────────────────────────────────────────────────────────────────────┘     │    ║
║   │   ┌───────────────────────────────────────────────────────────────────────────────────┐     │    ║
║   │   │  ERC1155接口 (条件代币是ERC1155):                                                 │     │    ║
║   │   │  ├── balanceOf(account, tokenId) → 查询持仓                                       │     │    ║
║   │   │  ├── balanceOfBatch(accounts, tokenIds) → 批量查询                                │     │    ║
║   │   │  ├── safeTransferFrom(...) → 转移代币                                             │     │    ║
║   │   │  └── setApprovalForAll(operator, approved) → 授权                                 │     │    ║
║   │   └───────────────────────────────────────────────────────────────────────────────────┘     │    ║
║   └─────────────────────────────────────────────────────────────────────────────────────────────┘    ║
║                                                 │                                                    ║
║         ┌───────────────────────────────────────┼───────────────────────────────────────┐            ║
║         │                                       │                                       │            ║
║         ▼                                       ▼                                       ▼            ║
║   ┌───────────────────────┐   ┌─────────────────────────────────────┐   ┌───────────────────────┐    ║
║   │  USDC (抵押品)        │   │     Neg-Risk CTF Adapter            │   │   Exchange Fee Module │    ║
║   │  0x2791Bca1f2de4661.. │   │     0xC5d563A36AE78145C45a50..      │   │                       │    ║
║   │  ├── ERC20标准        │   │   ┌───────────────────────────┐     │   │   ├── 动态费率计算    │    ║
║   │  ├── 6位小数          │   │   │ 多outcome市场支持         │     │   │   ├── 做市商费率优惠  │    ║
║   │  └── 是所有头寸的     │   │   │ ├── 如: 谁赢得大选?       │     │   │   └── 费用收集分配    │    ║
║   │      底层抵押品       │   │   │ │   A/B/C/D四个选项       │     │   │                       │    ║
║   └───────────────────────┘   │   │ ├── 确保Σ概率 = 100%      │     │   └───────────────────────┘    ║
║                               │   │ └── 负风险对冲机制        │     │                                ║
║                               │   └───────────────────────────┘     │                                ║
║                               │   ┌───────────────────────────┐     │                                ║
║                               │   │ Neg-Risk Exchange         │     │                                ║
║                               │   │ 0xd91E80cF2E7be2e162c65.. │     │                                ║
║                               │   │ └── 专门处理多选市场交易  │     │                                ║
║                               │   └───────────────────────────┘     │                                ║
║                               └─────────────────────────────────────┘                                ║
║                                                 │                                                    ║
║   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    ║
║   │                                    Proxy Factories                                          │    ║
║   │   └── 用于部署用户Safe钱包的工厂合约                                                        │    ║
║   └─────────────────────────────────────────────────────────────────────────────────────────────┘    ║
║                                                                                                      ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════╝
                                               │
                           ┌───────────────────┴───────────────────┐
                           │                                       │
                           ▼                                       ▼
╔════════════════════════════════════════════╗   ╔════════════════════════════════════════════════════╗
║          UMA Optimistic Oracle             ║   ║              数据索引层                            ║
╠════════════════════════════════════════════╣   ╠════════════════════════════════════════════════════╣
║                                            ║   ║                                                    ║
║  ┌──────────────────────────────────────┐  ║   ║  ┌────────────────────────────────────────────┐    ║
║  │       UMA CTF Adapter                │  ║   ║  │           The Graph / Subgraph             │    ║
║  │  0x... (UmaCtfAdapter合约)           │  ║   ║  │                                            │    ║
║  │  ┌────────────────────────────────┐  │  ║   ║  │  ┌────────────────────────────────────┐    │    ║
║  │  │ 功能:                          │  │  ║   ║  │  │  polymarket-subgraph (主索引)      │    │    ║
║  │  │ ├── initialize(questionId,     │  │  ║   ║  │  │  ├── 监听链上事件                  │    │    ║
║  │  │ │   ancillaryData)             │  │  ║   ║  │  │  ├── 索引: Trade, Market, User     │    │    ║
║  │  │ │   初始化市场问题             │  │  ║   ║  │  │  ├── 索引: Position, Liquidity     │    │    ║
║  │  │ ├── requestData()              │  │  ║   ║  │  │  └── GraphQL API查询               │    │    ║
║  │  │ │   向UMA请求结果              │  │  ║   ║  │  └────────────────────────────────────┘    │    ║
║  │  │ ├── settle()                   │  │  ║   ║  │  ┌────────────────────────────────────┐    │    ║
║  │  │ │   接收结果并结算             │  │  ║   ║  │  │  resolution-subgraph               │    │    ║
║  │  │ └── getExpectedPayouts()       │  │  ║   ║  │  │  └── 市场结算数据索引              │    │    ║
║  │  │     获取赔付比例               │  │  ║   ║  │  └────────────────────────────────────┘    │    ║
║  │  └────────────────────────────────┘  │  ║   ║  │  ┌────────────────────────────────────┐    │    ║
║  └──────────────────────────────────────┘  ║   ║  │  │  positions-subgraph                │    │    ║
║                    │                       ║   ║  │  │  └── 用户持仓数据索引              │    │    ║
║                    ▼                       ║   ║  │  └────────────────────────────────────┘    │    ║
║  ┌──────────────────────────────────────┐  ║   ║  └────────────────────────────────────────────┘    ║
║  │    UMA Optimistic Oracle (主网)      │  ║   ║                                                    ║
║  │  ┌────────────────────────────────┐  │  ║   ║  ┌────────────────────────────────────────────┐    ║
║  │  │ 结算流程:                      │  │  ║   ║  │           数据获取方式对比                 │    ║
║  │  │                                │  │  ║   ║  │  ┌────────────────────────────────────┐    │    ║
║  │  │ 1. 提议者提交结果              │  │  ║   ║  │  │  链上可查 (永久):                  │    │    ║
║  │  │    ├── 押金: 一定数量的UMA     │  │  ║   ║  │  │  ├── 成交记录 (OrderFilled)        │    │    ║
║  │  │    └── 提议: Yes赢 或 No赢     │  │  ║   ║  │  │  ├── 持仓变动 (Transfer)           │    │    ║
║  │  │                                │  │  ║   ║  │  │  ├── 市场结算 (ConditionResolution)│    │    ║
║  │  │ 2. 争议期 (2小时)              │  │  ║   ║  │  │  └── 当前余额 (balanceOf)          │    │    ║
║  │  │    ├── 任何人可以质疑          │  │  ║   ║  │  └────────────────────────────────────┘    │    ║
║  │  │    └── 质疑需要押金            │  │  ║   ║  │  ┌────────────────────────────────────┐    │    ║
║  │  │                                │  │  ║   ║  │  │  链下数据 (依赖PM):                │    │    ║
║  │  │ 3a. 无争议 → 自动结算          │  │  ║   ║  │  │  ├── 订单簿深度                    │    │    ║
║  │  │     └── 提议者取回押金+奖励    │  │  ║   ║  │  │  ├── 历史挂单记录                  │    │    ║
║  │  │                                │  │  ║   ║  │  │  ├── 撤单记录                      │    │    ║
║  │  │ 3b. 有争议 → DVM投票           │  │  ║   ║  │  │  └── 实时行情                      │    │    ║
║  │  │     ├── UMA代币持有者投票      │  │  ║   ║  │  └────────────────────────────────────┘    │    ║
║  │  │     ├── 投票期约48小时         │  │  ║   ║  └────────────────────────────────────────────┘    ║
║  │  │     └── 失败方损失押金         │  │  ║   ║                                                    ║
║  │  └────────────────────────────────┘  │  ║   ╚════════════════════════════════════════════════════╝
║  └──────────────────────────────────────┘  ║
║                    │                       ║
║                    ▼                       ║
║  ┌──────────────────────────────────────┐  ║
║  │      UMA Sports Oracle (体育)        │  ║
║  │  └── 专门用于体育赛事结果解析        │  ║
║  │      使用体育数据API作为数据源       │  ║
║  └──────────────────────────────────────┘  ║
║                                            ║
╚════════════════════════════════════════════╝


══════════════════════════════════════════════════════════════════════════════════════════════════════
                                        完整交易流程
══════════════════════════════════════════════════════════════════════════════════════════════════════

【买入Yes份额完整流程】

Step 1: 用户操作
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  用户在Web App选择市场 "Trump wins 2024"，输入买入 $1000 Yes @ 0.55                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
Step 2: 构建订单
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  SDK构建Order结构:                                                                                  │
│  {                                                                                                  │
│    maker: "0x用户Safe地址",                                                                         │
│    tokenId: "Yes代币的tokenId",                                                                     │
│    makerAmount: 1000000000 (1000 USDC, 6位小数),                                                    │
│    takerAmount: 1818181818 (≈1818个Yes份额, 按0.55价格),                                            │
│    side: BUY,                                                                                       │
│    expiration: 1735689600,                                                                          │
│    ...                                                                                              │
│  }                                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
Step 3: 签名
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Privy MPC系统:                                                                                     │
│  ├── 用户设备的密钥分片 + Privy服务器的密钥分片                                                     │
│  ├── 联合计算EIP-712签名                                                                            │
│  └── 输出: signature (用户无法看到完整私钥)                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
Step 4: 提交到链下订单簿
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  POST /orders → Polymarket API                                                                      │
│  订单进入Order Book，等待撮合                                                                        │
│  ※ 此时订单只存在于Polymarket服务器内存中，不在链上                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
Step 5: 撮合
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Matching Engine发现对手方:                                                                          │
│  ├── 有人在卖Yes @ 0.55 (或更低)                                                                    │
│  ├── 或者有人在买No @ 0.45 (互补订单，系统自动split USDC)                                           │
│  └── 撮合成功，生成matched order pair                                                                │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
Step 6: Builder打包
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  Builder Service:                                                                                    │
│  ├── 收集多个撮合结果                                                                                │
│  ├── 构建交易: CTFExchange.matchOrders([order1, order2, ...], [sig1, sig2, ...])                   │
│  ├── Relayer签名交易 (代付gas)                                                                       │
│  └── 提交到Polygon                                                                                   │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
Step 7: 链上执行
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  CTF Exchange合约:                                                                                   │
│  ├── 验证所有签名 ✓                                                                                 │
│  ├── 验证余额和授权 ✓                                                                               │
│  ├── 调用Conditional Tokens:                                                                        │
│  │   ├── 如果对手方卖Yes: 直接转移Yes代币                                                           │
│  │   └── 如果对手方买No: splitPosition(1000 USDC) → 1000 Yes + 1000 No                             │
│  │       然后: 用户得Yes, 对手方得No                                                                │
│  ├── 扣除手续费                                                                                      │
│  └── Emit OrderFilled事件                                                                            │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
Step 8: 结果
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  用户Safe钱包:                                                                                       │
│  ├── USDC: -1000 (加手续费)                                                                          │
│  └── Yes代币: +1818                                                                                  │
│                                                                                                      │
│  Subgraph索引事件，更新用户持仓记录                                                                  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘


【市场结算完整流程】

Step 1: 事件发生
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  现实世界: Trump赢得2024大选                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
Step 2: 提议者提交结果
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  UMA CTF Adapter:                                                                                    │
│  ├── 提议者调用proposePrice()                                                                        │
│  ├── 提交: outcome = [1, 0] (Yes=1, No=0)                                                           │
│  └── 质押UMA代币作为押金                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
Step 3: 争议期
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  2小时争议窗口:                                                                                      │
│  ├── 任何人可以质疑 (如果认为结果错误)                                                               │
│  ├── 质疑需要押金                                                                                    │
│  └── 本例无人质疑                                                                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
Step 4: 结算
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  UMA Oracle → CTF Adapter:                                                                           │
│  ├── settle() 被调用                                                                                 │
│  └── Conditional Tokens.reportPayouts(conditionId, [1, 0])                                          │
│      └── Yes赢，payout = [1, 0]                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
Step 5: 用户赎回
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  用户调用 redeemPositions():                                                                         │
│  ├── 输入: 1818个Yes代币                                                                             │
│  ├── 合约验证: 市场已结算，Yes赢                                                                     │
│  └── 输出: 1818 USDC (1 Yes = 1 USDC)                                                               │
│                                                                                                      │
│  持有No代币的用户:                                                                                   │
│  └── No代币价值归零，无法赎回                                                                        │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
```


<style>
  .graph-card {
    background: #1a1a1a;
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #333;
    margin-bottom: 15px;
  }

  .graph-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #333;
  }

  .graph-header h2 {
    font-size: 1.1em;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
  }

  .graph-header h2::before {
    content: "";
    width: 3px;
    height: 16px;
    background: #6366f1;
    border-radius: 2px;
  }

  .graph-source {
    background: #252525;
    border-radius: 6px;
    margin-bottom: 8px;
    overflow: hidden;
  }

  .graph-source:last-child {
    margin-bottom: 0;
  }

  .graph-source-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: #2a2a2a;
    cursor: pointer;
  }

  .graph-source-header:hover {
    background: #333;
  }

  .graph-source-title {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .graph-source-name {
    font-weight: 600;
    color: #fff;
  }

  .graph-source-id {
    font-family: monospace;
    font-size: 0.7em;
    color: #666;
    word-break: break-all;
  }

  .graph-source-stats {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 0.8em;
    flex-shrink: 0;
  }

  .graph-stat-mini {
    text-align: right;
  }

  .graph-stat-mini .label {
    font-size: 0.7em;
    color: #666;
  }

  .graph-stat-mini .value {
    font-family: monospace;
    color: #6366f1;
  }

  .graph-stat-mini .value.synced {
    color: #4ade80;
  }

  .graph-stat-mini .value.behind {
    color: #fde047;
  }

  .graph-stat-mini .value.error {
    color: #f87171;
  }

  .badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.7em;
    font-weight: 500;
  }

  .badge-success {
    background: #166534;
    color: #4ade80;
  }

  .badge-warning {
    background: #854d0e;
    color: #fde047;
  }

  .badge-error {
    background: #991b1b;
    color: #fca5a5;
  }

  .graph-source-body {
    padding: 12px;
    display: none;
    font-size: 0.85em;
  }

  .graph-source.expanded .graph-source-body {
    display: block;
  }

  .graph-source.expanded .graph-source-header {
    border-bottom: 1px solid #333;
  }

  .indexer-list {
    margin-top: 10px;
  }

  .indexer-list .title {
    font-size: 0.8em;
    color: #888;
    margin-bottom: 6px;
  }

  .indexer-item {
    display: flex;
    justify-content: space-between;
    padding: 4px 8px;
    background: #1a1a1a;
    border-radius: 3px;
    margin-bottom: 4px;
    font-size: 0.8em;
  }

  .indexer-item .name {
    color: #aaa;
    font-family: monospace;
    word-break: break-all;
  }

  .indexer-item .stake {
    color: #6366f1;
    flex-shrink: 0;
    margin-left: 12px;
  }

  .data-sources {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #333;
  }

  .data-sources .title {
    font-size: 0.8em;
    color: #888;
    margin-bottom: 6px;
  }

  .ds-item {
    background: #1a1a1a;
    border-radius: 4px;
    padding: 8px 10px;
    margin-bottom: 6px;
    border-left: 2px solid #6366f1;
  }

  .ds-item.dynamic {
    border-left-color: #f59e0b;
  }

  .ds-type {
    font-size: 0.7em;
    padding: 1px 4px;
    border-radius: 2px;
    margin-right: 4px;
  }

  .ds-type.static {
    background: #1e3a5f;
    color: #60a5fa;
  }

  .ds-type.dynamic {
    background: #4a3728;
    color: #fbbf24;
  }

  .ds-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.75em;
    gap: 8px;
  }

  .ds-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .ds-name {
    color: #fff;
    font-weight: 500;
    min-width: 100px;
  }

  .ds-blocks {
    display: flex;
    gap: 10px;
    color: #888;
  }

  .ds-blocks .val {
    color: #6366f1;
    font-family: monospace;
  }

  .ds-blocks .val.synced {
    color: #4ade80;
  }

  .ds-blocks .val.behind {
    color: #fde047;
  }

  .ds-blocks .val.error {
    color: #f87171;
  }

  .ds-right {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  .ds-network {
    color: #888;
    background: #333;
    padding: 2px 6px;
    border-radius: 2px;
  }

  .ds-progress {
    font-weight: 500;
    padding: 2px 8px;
    border-radius: 3px;
    min-width: 60px;
    text-align: center;
  }

  .ds-progress.synced {
    background: #166534;
    color: #4ade80;
  }

  .ds-progress.behind {
    background: #854d0e;
    color: #fde047;
  }

  .ds-progress.error {
    background: #991b1b;
    color: #fca5a5;
  }

  .ds-addr {
    font-family: monospace;
    font-size: 0.7em;
    color: #666;
    margin-top: 4px;
  }

  .ds-entities {
    font-size: 0.7em;
    color: #666;
    margin-top: 6px;
  }

  .ds-entities-gray {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
    margin-bottom: 4px;
  }

  .ds-entities-gray span {
    background: #333;
    padding: 1px 4px;
    border-radius: 2px;
  }

  .ds-entity-row {
    display: flex;
    align-items: center;
    padding: 3px 6px;
    background: #1e2e1e;
    border-radius: 3px;
    margin-bottom: 2px;
    color: #4ade80;
    font-family: monospace;
    font-size: 0.8em;
  }

  .ds-entity-row .name {
    font-weight: 500;
    width: 180px;
    flex-shrink: 0;
  }

  .ds-entity-row .stat {
    color: #86efac;
    width: 90px;
    text-align: right;
    flex-shrink: 0;
  }

  .ds-entity-row .stat.syncing {
    color: #fbbf24;
  }

  .ds-entity-row .stat.error {
    color: #f87171;
  }

  .ds-entity-row .size {
    color: #888;
    width: 70px;
    text-align: right;
    flex-shrink: 0;
  }

  .ds-entity-row .sync-status {
    width: 60px;
    text-align: center;
    flex-shrink: 0;
  }

  .ds-entity-row .sync-status.done {
    color: #4ade80;
  }

  .ds-entity-row .sync-status.syncing {
    color: #fbbf24;
  }

  .ds-entity-row .qos {
    display: flex;
    gap: 6px;
    color: #6b7280;
    margin-left: auto;
  }

  .ds-entity-row .qos span {
    display: flex;
    align-items: center;
    gap: 2px;
    width: 70px;
    justify-content: flex-end;
  }

  .ds-entity-row .qos span:last-child {
    width: 110px;
  }

  .ds-entity-row .qos .good {
    color: #4ade80;
  }

  .ds-entity-row .qos .warn {
    color: #fbbf24;
  }

  .ds-entity-row .qos .bad {
    color: #f87171;
  }

  .api-indicator {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-left: 6px;
  }

  .api-indicator.idle {
    background: #4b5563;
  }

  .api-indicator.calling {
    background: #3b82f6;
    animation: pulse-calling 0.6s ease-in-out infinite;
  }

  .api-indicator.processing {
    background: #f59e0b;
    animation: pulse-processing 1.2s ease-in-out infinite;
  }

  @keyframes pulse-calling {

    0%,
    100% {
      opacity: 1;
      transform: scale(1);
    }

    50% {
      opacity: 0.5;
      transform: scale(1.3);
    }
  }

  @keyframes pulse-processing {

    0%,
    100% {
      opacity: 1;
    }

    50% {
      opacity: 0.3;
    }
  }

  .expand-icon {
    color: #666;
    font-size: 0.8em;
    transition: transform 0.2s;
  }

  .graph-source.expanded .expand-icon {
    transform: rotate(180deg);
  }

  .btn-sm {
    padding: 5px 10px;
    font-size: 0.8em;
    background: #333;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .btn-sm:hover {
    background: #444;
  }

  .btn-sm:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .error-msg {
    color: #f87171;
    font-size: 0.85em;
    padding: 8px;
    background: #1a1a1a;
    border-radius: 4px;
  }

  .graph-status-msg {
    font-size: 0.8em;
    color: #888;
    margin-right: 8px;
  }

  .graph-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    color: #888;
  }

  /* 进度条栏 */
  .progress-card {
    background: #1a1a1a;
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #333;
    margin-bottom: 15px;
  }
  .progress-card h2 {
    font-size: 1.1em;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0 0 12px;
  }
  .progress-card h2::before {
    content: "";
    width: 3px;
    height: 16px;
    background: #6366f1;
    border-radius: 2px;
  }
  .progress-row {
    display: grid;
    grid-template-columns: 120px 1fr 50px 52px;
    align-items: center;
    gap: 4px 10px;
    margin-bottom: 10px;
    font-size: 0.82em;
  }
  .progress-row:last-child { margin-bottom: 0; }
  .progress-label {
    color: #aaa;
    font-weight: 500;
    white-space: nowrap;
  }
  .progress-bar-wrap {
    position: relative;
    height: 20px;
    background: #252525;
    border-radius: 4px;
    overflow: hidden;
  }
  .progress-bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
  }
  .progress-bar-fill.eof { background: #6366f1; }
  .progress-bar-fill.token { background: #f59e0b; }
  .progress-dates {
    display: flex;
    justify-content: space-between;
    font-size: 0.7em;
    color: #666;
    margin-top: 2px;
    font-family: monospace;
  }
  .progress-pct {
    text-align: right;
    font-family: monospace;
    color: #aaa;
  }
  .btn-fill {
    padding: 3px 10px;
    font-size: 0.78em;
    background: #92400e;
    color: #fbbf24;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-fill:hover { background: #78350f; }
  .btn-fill:disabled { opacity: 0.5; cursor: not-allowed; }
</style>

<!-- 数据同步进度 -->
<div class="progress-card" id="sync-progress-card">
  <h2>数据同步进度</h2>
  <div class="progress-row">
    <span class="progress-label">交易订单</span>
    <div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill eof" id="eof-bar" style="width:0%"></div>
      </div>
      <div class="progress-dates">
        <span id="eof-min">-</span>
        <span>已同步至 <span id="eof-synced" style="color:#6366f1">-</span></span>
        <span id="eof-now">-</span>
      </div>
    </div>
    <span class="progress-pct" id="eof-pct">-</span>
    <span></span>
  </div>
  <div class="progress-row">
    <span class="progress-label">交易市场</span>
    <div>
      <div class="progress-bar-wrap">
        <div class="progress-bar-fill token" id="token-bar" style="width:0%"></div>
      </div>
      <div class="progress-dates">
        <span id="token-min">-</span>
        <span>已同步至 <span id="token-synced" style="color:#f59e0b">-</span></span>
        <span id="token-now">-</span>
      </div>
    </div>
    <span class="progress-pct" id="token-pct">-</span>
    <button class="btn-fill" id="fill-btn" onclick="fillTokenIds()">填充</button>
  </div>
</div>

<div class="graph-card" id="graph-status-card">
  <div class="graph-header">
    <h2>索引服务器节点</h2>
    <div style="display: flex; align-items: center; gap: 6px">
      <span class="graph-status-msg" id="graph-status-msg"></span>
      <button class="btn-sm" onclick="refreshGraphStatus()" id="graph-refresh-btn">
        刷新
      </button>
      <select id="graph-export-order" class="btn-sm" style="padding: 2px 4px;">
        <option value="desc">最新</option>
        <option value="asc">最早</option>
      </select>
      <button class="btn-sm" onclick="exportData()" id="graph-export-btn">
        导出
      </button>
    </div>
  </div>
  <div id="graph-sources-container">
    <div class="graph-loading">加载中...</div>
  </div>
</div>

<script>
  window._graphData = null;
  let _entityStatsTimer = null;

  function toggleSource(headerEl) {
    if (event.target.closest(".btn-sm")) return;
    const sourceEl = headerEl.parentElement;
    sourceEl.classList.toggle("expanded");
  }

  function refreshGraphStatus() {
    const btn = document.getElementById("graph-refresh-btn");
    const statusMsg = document.getElementById("graph-status-msg");
    const container = document.getElementById("graph-sources-container");

    btn.disabled = true;
    btn.textContent = "...";
    statusMsg.textContent = "连接中...";

    const eventSource = new EventSource("/api/graph-status-stream");

    eventSource.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === "status") {
        statusMsg.textContent = data.msg;
      } else if (data.type === "done") {
        eventSource.close();
        statusMsg.textContent = "";
        btn.disabled = false;
        btn.textContent = "刷新";

        if (data.data.error) {
          container.innerHTML = `<div class="error-msg">${data.data.error}</div>`;
        } else {
          window._graphData = data.data;
          container.innerHTML = renderGraphSources(data.data);
          attachEntityLatestHover();
          attachIndexerFailHover();
          startEntityStatsPolling();
        }
      }
    };

    eventSource.onerror = () => {
      eventSource.close();
      statusMsg.textContent = "加载失败";
      btn.disabled = false;
      btn.textContent = "刷新";
    };
  }

  // 自动轮询 entity stats(高效，只更新 DOM 中的数字)
  function startEntityStatsPolling() {
    if (_entityStatsTimer) clearInterval(_entityStatsTimer);

    async function pollStats() {
      try {
        const resp = await fetch("/api/entity-stats");
        if (!resp.ok) return;
        const stats = await resp.json();
        updateEntityStatsUI(stats);
      } catch (e) { }
    }

    pollStats();
    _entityStatsTimer = setInterval(pollStats, 2000);
  }

  // hover 时按需拉取最近一条 entity 数据(带 schema)
  function _entityLatestTitle(entity, data) {
    if (!data || typeof data !== "object") return "无数据";
    const table = data.table || "";
    const cols = Array.isArray(data.columns) ? data.columns : [];
    const row = data.row ?? null;

    const colsText = cols
      .map((c) => `${c.name || ""} ${c.type || ""}`.trim())
      .filter((s) => s.length)
      .join("\n");

    let rowText = row === null ? "null" : JSON.stringify(row, null, 2);
    if (rowText.length > 2000)
      rowText = rowText.slice(0, 2000) + "\n...truncated";

    return (
      `Entity: ${entity}\n` +
      (table ? `Table: ${table}\n` : "") +
      `\nSchema:\n${colsText || "(empty)"}\n` +
      `\nLatest row:\n${rowText}`
    );
  }

  function attachEntityLatestHover() {
    document.querySelectorAll(".ds-entity-row .name").forEach((el) => {
      if (el.dataset.latestHoverBound === "1") return;
      el.dataset.latestHoverBound = "1";

      el.addEventListener("mouseenter", async () => {
        const row = el.closest(".ds-entity-row");
        const entity = row?.dataset?.entity || el.textContent || "";
        if (!entity) return;

        el.title = "加载最近一条数据...";

        const data = await fetch(
          `/api/entity-latest?entity=${encodeURIComponent(entity)}`,
        ).then((r) => (r.ok ? r.json() : null));
        el.title = _entityLatestTitle(entity, data);
      });
    });
  }

  // hover success 时按需拉取 indexer 失败计数
  function attachIndexerFailHover() {
    document
      .querySelectorAll(".ds-entity-row [data-field='success']")
      .forEach((successEl) => {
        const host = successEl.parentElement;
        if (!host || host.dataset.indexerFailBound === "1") return;
        host.dataset.indexerFailBound = "1";

        host.addEventListener("mouseenter", async () => {
          if (host.dataset.indexerFailInFlight === "1") return;
          const row = host.closest(".ds-entity-row");
          const source = row?.dataset?.source || "";
          const entity = row?.dataset?.entity || "";
          if (!source || !entity) return;

          host.dataset.indexerFailInFlight = "1";
          try {
            const rows = await fetch(
              `/api/indexer-fails?source=${encodeURIComponent(source)}&entity=${encodeURIComponent(entity)}`,
            ).then((r) => (r.ok ? r.json() : []));

            let text = "";
            if (Array.isArray(rows) && rows.length) {
              const lines = rows
                .slice(0, 10)
                .map((r) => `${r.indexer}: ${r.fail_requests}`);
              text = `\nIndexers(BadResponse失败 top10):\n` + lines.join("\n");
            }

            host.dataset.indexerFailText = text;
            host.title = (host.dataset.baseTitle || host.title || "") + text;
          } finally {
            host.dataset.indexerFailInFlight = "0";
          }
        });
      });
  }

  function updateEntityStatsUI(stats) {
    const sourceSyncMap = new Map(); // source -> needsSyncing

    document.querySelectorAll(".ds-entity-row").forEach((row) => {
      const source = row.dataset.source;
      const entity = row.dataset.entity;
      const key = `${source}/${entity}`;
      const stat = stats[key];

      if (!stat) {
        // 没拿到 stat 就按未完成处理
        row.dataset.done = "0";
        row.dataset.syncing = "0";
        sourceSyncMap.set(source, true);
        return;
      }

      // 更新 count
      const countEl = row.querySelector('[data-field="count"]');
      if (countEl) {
        countEl.textContent = stat.count?.toLocaleString() || "0";
        countEl.classList.toggle("syncing", stat.is_syncing);
      }

      // 更新 speed
      const speedEl = row.querySelector('[data-field="speed"]');
      if (speedEl) {
        speedEl.textContent = stat.speed?.toFixed(1) || "0";
      }

      // 更新 latency
      const latencyEl = row.querySelector('[data-field="latency"]');
      if (latencyEl) {
        const latency = stat.avg_latency_ms || 0;
        latencyEl.textContent = Math.round(latency);
        latencyEl.parentElement.className =
          latency < 500 ? "good" : latency < 2000 ? "warn" : "bad";
      }

      // 更新 success rate
      const successEl = row.querySelector('[data-field="success"]');
      if (successEl) {
        const rate = stat.success_rate || 0;
        successEl.textContent = rate.toFixed(1);
        successEl.parentElement.className =
          rate > 95 ? "good" : rate > 80 ? "warn" : "bad";

        const succ = stat.success_requests ?? 0;
        const tot = stat.total_requests ?? 0;
        const countsEl = row.querySelector('[data-field="success_counts"]');
        if (countsEl) countsEl.textContent = ` (${succ}/${tot})`;

        const fNet = stat.fail_network ?? 0;
        const fJson = stat.fail_json ?? 0;
        const fGql = stat.fail_graphql ?? 0;
        const fFmt = stat.fail_format ?? 0;
        const host = successEl.parentElement;
        const baseTitle =
          `成功率 ${rate.toFixed(1)}% (${succ}/${tot})\n` +
          `失败分类：网络 ${fNet}，JSON ${fJson}，GraphQL ${fGql}，格式 ${fFmt}`;
        host.dataset.baseTitle = baseTitle;
        host.title = baseTitle + (host.dataset.indexerFailText || "");
      }

      // 更新 size (MB)
      const sizeEl = row.querySelector('[data-field="size_mb"]');
      if (sizeEl) {
        const mb = stat.db_size_mb || 0;
        sizeEl.textContent = mb.toFixed(2);
      }

      // 更新 sync 状态
      const syncEl = row.querySelector('[data-field="sync"]');
      if (syncEl) {
        let text = "PEND";
        let cls = "";
        if (stat.is_syncing) {
          text = "SYNC";
          cls = "syncing";
        } else if (stat.sync_done) {
          text = "DONE";
          cls = "done";
        }

        syncEl.className = `sync-status ${cls}`.trim();

        // 获取或创建API指示器
        let apiIndicator = syncEl.querySelector(".api-indicator");
        if (!apiIndicator) {
          syncEl.innerHTML = text;
          apiIndicator = document.createElement("span");
          apiIndicator.className = "api-indicator idle";
          apiIndicator.setAttribute("data-field", "api_indicator");
          apiIndicator.title = "API状态";
          syncEl.appendChild(apiIndicator);
        } else {
          // 更新文本，保留API指示器
          const firstChild = syncEl.firstChild;
          if (firstChild && firstChild.nodeType === Node.TEXT_NODE) {
            firstChild.textContent = text;
          } else {
            syncEl.insertBefore(
              document.createTextNode(text),
              syncEl.firstChild,
            );
          }
        }

        // 更新 API 状态指示器
        if (stat.api_state) {
          apiIndicator.className = `api-indicator ${stat.api_state}`;
          const stateText = {
            idle: "空闲",
            calling: "API调用中",
            processing: "解析/等待中",
          };
          apiIndicator.title = stateText[stat.api_state] || "API状态";
        }
      }

      row.dataset.done = stat.sync_done ? "1" : "0";
      row.dataset.syncing = stat.is_syncing ? "1" : "0";

      const needsSyncing = stat.is_syncing || !stat.sync_done;
      sourceSyncMap.set(
        source,
        sourceSyncMap.get(source) || false || needsSyncing,
      );
    });

    // node 级：如果任意 entity 未完成，同节点表头显示 syncing
    document.querySelectorAll(".ds-item").forEach((item) => {
      const badge = item.querySelector(".node-sync-badge");
      if (!badge) return;
      const rows = item.querySelectorAll(".ds-entity-row");
      if (!rows.length) {
        badge.style.display = "none";
        return;
      }
      let anyNotDone = false;
      rows.forEach((r) => {
        if (r.dataset.done !== "1") anyNotDone = true;
      });
      badge.style.display = anyNotDone ? "inline-block" : "none";
    });

    // source 级：如果任意 entity 未完成，source 表头显示 syncing
    document.querySelectorAll(".graph-source").forEach((gs) => {
      const srcName = gs.dataset.sourceName || "";
      const badge = gs.querySelector(".source-sync-badge");
      if (!badge) return;
      badge.style.display = sourceSyncMap.get(srcName)
        ? "inline-block"
        : "none";
    });
  }

  document.addEventListener("DOMContentLoaded", refreshGraphStatus);

  async function exportData() {
    const btn = document.getElementById("graph-export-btn");
    const statusMsg = document.getElementById("graph-status-msg");
    const orderSelect = document.getElementById("graph-export-order");
    btn.disabled = true;
    btn.textContent = "...";
    statusMsg.textContent = "导出中...";

    const limit = 1000;
    const order = orderSelect.value;
    try {
      const resp = await fetch(`/api/export?limit=${limit}&order=${order}`);
      const data = await resp.json();
      if (data.error) {
        statusMsg.textContent = "导出失败";
      } else {
        const orderText = order === "asc" ? "最早" : "最新";
        statusMsg.textContent = `导出完成: ${data.exported_tables} 表, ${orderText} ${limit} 条`;
        setTimeout(() => { statusMsg.textContent = ""; }, 3000);
      }
    } catch (e) {
      statusMsg.textContent = "导出失败";
    } finally {
      btn.disabled = false;
      btn.textContent = "导出";
    }
  }

  function renderGraphSources(data) {
    let html = "";
    for (const [name, src] of Object.entries(data.sources)) {
      const meta = src.meta || {};
      const stats = src.stats || {};
      const indexerInfo = src.indexer_info || {};
      const hasError = !!meta.error;

      const statusBadge = hasError
        ? '<span class="badge badge-error">错误</span>'
        : meta.hasIndexingErrors
          ? '<span class="badge badge-warning">索引错误</span>'
          : '<span class="badge badge-success">正常</span>';

      const progressClass =
        stats.progress > 99
          ? "synced"
          : stats.progress > 90
            ? "behind"
            : "error";

      html += `<div class="graph-source" data-source-name="${name}">
            <div class="graph-source-header" onclick="toggleSource(this)">
                <div class="graph-source-title">
                    <span class="graph-source-name">${name}</span>
                    <span class="graph-source-id">${src.subgraph_id}</span>
                    ${statusBadge}
                    <span class="badge badge-warning source-sync-badge" style="display:none;">syncing</span>
                </div>
                <div class="graph-source-stats">
                    ${!hasError
          ? `
                    <div class="graph-stat-mini"><div class="label">Indexers</div><div class="value">${indexerInfo.indexer_count || 0}</div></div>
                    <div class="graph-stat-mini"><div class="label">Progress</div><div class="value ${progressClass}">${stats.progress || 0}%</div></div>
                    `
          : ""
        }
                    <span class="expand-icon">▼</span>
                </div>
            </div>
            <div class="graph-source-body">
                ${hasError ? `<div class="error-msg">${meta.error}</div>` : renderSourceBody(src)}
            </div>
        </div>`;
    }
    return html;
  }

  function renderSourceBody(src) {
    const indexerInfo = src.indexer_info || {};
    let html = "";

    if (indexerInfo.indexers?.length) {
      html += `<div class="indexer-list"><div class="title">Active Indexers (Top ${indexerInfo.indexers.length} by stake)</div>`;
      for (const idx of indexerInfo.indexers) {
        const grt = Math.round(parseInt(idx.allocated) / 1e18);
        html += `<div class="indexer-item"><span class="name">${idx.id}</span><span class="stake">${grt.toLocaleString()} GRT</span></div>`;
      }
      html += "</div>";
    }

    if (src.contract_nodes?.length) {
      const configuredSet = new Set(src.configured_entities || []);
      const sourceName =
        src.source_name ||
        Object.keys(window._graphData?.sources || {}).find(
          (k) => window._graphData.sources[k] === src,
        ) ||
        "";

      html += `<div class="data-sources"><div class="title">智能合约节点 (${src.contract_nodes.length})</div>`;
      for (const node of src.contract_nodes) {
        const isStatic = node.type === "static";
        const typeLabel = isStatic ? "静态" : "动态";
        const typeClass = isStatic ? "static" : "dynamic";
        const progressClass =
          node.progress > 99
            ? "synced"
            : node.progress > 90
              ? "behind"
              : "error";
        const behindClass =
          node.behind < 100
            ? "synced"
            : node.behind < 10000
              ? "behind"
              : "error";

        // 分离 entities
        const grayEntities = (node.entities || []).filter(
          (e) => !configuredSet.has(e),
        );
        const greenEntities = (node.entities || []).filter((e) =>
          configuredSet.has(e),
        );

        html += `<div class="ds-item ${typeClass}">
                <div class="ds-row">
                    <div class="ds-left">
                        <span class="ds-type ${typeClass}">${typeLabel}</span>
                        <span class="ds-name">${node.name}</span>
                        <span class="badge badge-warning node-sync-badge" style="display:none;">syncing</span>
                        <div class="ds-blocks">
                            ${isStatic ? `<span>Start: <span class="val">${node.start_block?.toLocaleString()}</span></span>` : ""}
                            <span>Indexed: <span class="val">${node.indexed?.toLocaleString() || "N/A"}</span></span>
                            <span>Head: <span class="val">${node.head?.toLocaleString() || "N/A"}</span></span>
                            <span>Behind: <span class="val ${behindClass}">${node.behind?.toLocaleString() || "N/A"}</span></span>
                        </div>
                    </div>
                    <div class="ds-right">
                        <span class="ds-network">${node.network_display}</span>
                        ${isStatic ? `<span class="ds-progress ${progressClass}">${node.progress || 0}%</span>` : ""}
                    </div>
                </div>
                ${node.address ? `<div class="ds-addr">${node.address}</div>` : ""}
                <div class="ds-entities">
                    ${grayEntities.length ? `<div class="ds-entities-gray">${grayEntities.map((e) => `<span>${e}</span>`).join("")}</div>` : ""}
                    ${greenEntities
            .map(
              (
                e,
              ) => `<div class="ds-entity-row" data-source="${sourceName}" data-entity="${e}" data-done="0" data-syncing="0">
                        <span class="name">${e}</span>
                        <span class="stat count" data-field="count">-</span>
                        <span class="size" title="估算 DB 大小 (MB)"><span data-field="size_mb">-</span>MB</span>
                        <span class="sync-status" title="同步状态" data-field="sync">-<span class="api-indicator idle" data-field="api_indicator" title="API状态"></span></span>
                        <span class="qos">
                            <span title="速度"><span data-field="speed">-</span>/s</span>
                            <span title="延时"><span data-field="latency">-</span>ms</span>
                            <span title="成功率"><span data-field="success">-</span>%<span data-field="success_counts"></span></span>
                        </span>
                    </div>`,
            )
            .join("")}
                </div>
            </div>`;
      }
      html += "</div>";
    }

    return html;
  }

  // ============================================================================
  // 数据同步进度
  // ============================================================================
  let _syncProgressTimer = null;

  function fmtDate(ts) {
    if (!ts) return "-";
    const d = new Date(ts * 1000);
    return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0") + "-" + String(d.getDate()).padStart(2, "0");
  }

  function fmtDateTime(ts) {
    if (!ts) return "-";
    const d = new Date(ts * 1000);
    return d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0") + "-" + String(d.getDate()).padStart(2, "0")
      + " " + String(d.getHours()).padStart(2, "0") + ":" + String(d.getMinutes()).padStart(2, "0");
  }

  function updateSyncProgress(data) {
    const pct = (min, synced, now) => {
      if (!min || !now || now <= min) return 0;
      return Math.min(100, Math.max(0, ((synced - min) / (now - min)) * 100));
    };

    const eofP = pct(data.eof_min_ts, data.eof_synced_ts, data.now_ts);
    document.getElementById("eof-bar").style.width = eofP + "%";
    document.getElementById("eof-pct").textContent = eofP.toFixed(1) + "%";
    document.getElementById("eof-min").textContent = fmtDate(data.eof_min_ts);
    document.getElementById("eof-synced").textContent = fmtDateTime(data.eof_synced_ts);
    document.getElementById("eof-now").textContent = fmtDate(data.now_ts);

    const tokP = pct(data.token_min_ts, data.token_synced_ts, data.now_ts);
    document.getElementById("token-bar").style.width = tokP + "%";
    document.getElementById("token-pct").textContent = tokP.toFixed(1) + "%";
    document.getElementById("token-min").textContent = fmtDate(data.token_min_ts);
    document.getElementById("token-synced").textContent = fmtDateTime(data.token_synced_ts);
    document.getElementById("token-now").textContent = fmtDate(data.now_ts);

    const btn = document.getElementById("fill-btn");
    if (data.filler_running) {
      btn.disabled = true;
      window._fillerWasRunning = true;
      if (data.filler_phase === 1) {
        btn.textContent = "合并中...";
      } else if (data.filler_phase === 2) {
        btn.textContent = "查询中 (" + (data.filler_processed || 0).toLocaleString() + ")";
      } else {
        btn.textContent = "启动中...";
      }
    } else if (window._fillerWasRunning) {
      window._fillerWasRunning = false;
      const total = (data.filler_merged || 0) + (data.filler_processed || 0);
      btn.disabled = true;
      btn.textContent = "完成 " + total.toLocaleString() + "条";
      setTimeout(() => { btn.disabled = false; btn.textContent = "填充"; }, 3000);
    } else {
      btn.disabled = false;
      btn.textContent = "填充";
    }
  }

  async function pollSyncProgress() {
    try {
      const resp = await fetch("/api/sync-progress");
      if (resp.ok) updateSyncProgress(await resp.json());
    } catch (_) {}
  }

  function startSyncProgressPolling() {
    if (_syncProgressTimer) clearInterval(_syncProgressTimer);
    pollSyncProgress();
    _syncProgressTimer = setInterval(pollSyncProgress, 2000);
  }

  async function fillTokenIds() {
    const btn = document.getElementById("fill-btn");
    btn.disabled = true;
    btn.textContent = "启动中...";
    try {
      const resp = await fetch("/api/fill-token-ids", { method: "POST" });
      const data = await resp.json();
      if (data.status !== "started") {
        btn.textContent = data.status;
        setTimeout(() => { btn.disabled = false; btn.textContent = "填充"; }, 2000);
      }
    } catch (_) {
      btn.textContent = "失败";
      setTimeout(() => { btn.disabled = false; btn.textContent = "填充"; }, 2000);
    }
  }

  document.addEventListener("DOMContentLoaded", startSyncProgressPolling);
</script>